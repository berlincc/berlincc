<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="thinkphp3.2与thinkPHP5.0的区别一、thinkphp3.2与thinkPHP5.0不同之处5.0版本和之前版本的差异较大，本篇对熟悉3.2版本的用户给出了一些5.0的主要区别。模块和控制器控制器的命名空间有所调整，并且可以无需继承任何的控制器类。应用命名空间统一为app（可定义）而不是模块名；控制器的类名默认不带Controller后缀；控制器操作方法采用return方式返回数">
<meta property="og:type" content="article">
<meta property="og:title" content="thinkphp5 的model层">
<meta property="og:url" content="http://yoursite.com/2018/12/12/model/index.html">
<meta property="og:site_name" content="Berlin&#39;s Blog">
<meta property="og:description" content="thinkphp3.2与thinkPHP5.0的区别一、thinkphp3.2与thinkPHP5.0不同之处5.0版本和之前版本的差异较大，本篇对熟悉3.2版本的用户给出了一些5.0的主要区别。模块和控制器控制器的命名空间有所调整，并且可以无需继承任何的控制器类。应用命名空间统一为app（可定义）而不是模块名；控制器的类名默认不带Controller后缀；控制器操作方法采用return方式返回数">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-11T16:20:29.802Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="thinkphp5 的model层">
<meta name="twitter:description" content="thinkphp3.2与thinkPHP5.0的区别一、thinkphp3.2与thinkPHP5.0不同之处5.0版本和之前版本的差异较大，本篇对熟悉3.2版本的用户给出了一些5.0的主要区别。模块和控制器控制器的命名空间有所调整，并且可以无需继承任何的控制器类。应用命名空间统一为app（可定义）而不是模块名；控制器的类名默认不带Controller后缀；控制器操作方法采用return方式返回数">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/12/model/">





  <title>thinkphp5 的model层 | Berlin's Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Berlin's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The end of science is theology.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-report">
          <a href="/report" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            Report
          </a>
        </li>
      
        
        <li class="menu-item menu-item-thanks">
          <a href="/thanks" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            Thanks
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            TODO
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/12/model/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Berlin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Berlin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">thinkphp5 的model层</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-12T00:17:49+08:00">
                2018-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7,748
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  31
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>thinkphp3.2与thinkPHP5.0的区别<br>一、thinkphp3.2与thinkPHP5.0不同之处<br>5.0版本和之前版本的差异较大，本篇对熟悉3.2版本的用户给出了一些5.0的主要区别。<br>模块和控制器<br>控制器的命名空间有所调整，并且可以无需继承任何的控制器类。<br>应用命名空间统一为app（可定义）而不是模块名；<br>控制器的类名默认不带Controller后缀；<br>控制器操作方法采用return方式返回数据 而非直接输出；<br>废除原来的操作前后置方法；<br>支持任意层次的控制器定义和访问；<br>URL访问支持自动定位控制器；<br>数据库<br>5.0的数据库查询功能增强，原先需要通过模型才能使用的链式查询可以直接通过Db类调用，原来的M函数调用可以改用db函数，例如：<br>3.2版本<br><code>M(‘User’)-&gt;where([‘name’=&gt;’thinkphp’])-&gt;find();</code><br>5.0版本<br><code>db(‘User’)-&gt;where(‘name’,’thinkphp’)-&gt;find();</code><br>主要改进如下：<br>支持链式查询操作；<br>数据查询支持返回对象、数组和PDOStatement对象；<br>数据集查询支持返回数组和Collection对象；<br>增加查询构造器，查询语法改变；<br>支持闭包查询；<br>支持分块查询；<br>支持视图查询；<br>增加SQL监听事件；</p>
<p>模型</p>
<p>5.0的模型变化是最大的，基本上模型是完全面向对象的概念，包括关联模型，模型类的后缀不再带Model，直接由命名空间区分，原来的D函数调用改为model函数，并且必须创建对应的模型类，例如：</p>
<p>3.2版本<br><code>D(&#39;User&#39;)-&gt;where([&#39;name&#39;=&gt;&#39;thinkphp&#39;])-&gt;find();</code><br>5.0版本<br><code>model(&#39;User&#39;)-&gt;where(&#39;name&#39;,&#39;thinkphp&#39;)-&gt;find();</code><br>主要改进包括：<br>重构关联模型；<br>支持聚合模型；<br>废除视图模型（改为数据库的视图查询方法）；<br>增加获取器和修改器；<br>增加时间戳自动写入；<br>增加类型字段转换；<br>数组访问支持；<br>JSON序列化支持；</p>
<p>5.0的数据自动完成和3.2版本区别较大，自动完成则通过在模型里面定义修改器来完成。</p>
<p>二、模型</p>
<p>模型定义</p>
<p>模型就是一个实体类，里面包含一些属性和方法。</p>
<p>定义一个User模型类：<br><code>namespace app\index\model;</code></p>
<p><code>use think\Model;
//定义时继承副类Modex
class Users extends Model
{
//默认表名绑定类名，类名大写，表前缀在数据库配置文件中配置
模型名 约定对应数据表（假设数据库的前缀定义是 ecs_）
Users=&gt;ecs_users
//注意：以下情况使用较少
//设置数据表(不含前缀)
protected $name = “admin”;
//设置完整数据表（含前缀）
protected $table = ‘ecs_admin’;
//设置主键(默认主键自动识别)
protected $pk = ‘uid’;
}</code><br>//使用实例<br>例如在Index模块的index控制器下面使用<br>引入命名空间才能使用<br><code>app/Index/Model/Users;
public function test(){
//查询users表中id=1的数据(先查询表结构，再根据主键查询)
$a=Users::get(1);
}
//插入操作</code></p>
<p>模型调用<br>模型类可以使用静态调用或者实例化调用两种方式，例如：</p>
<p>// 静态调用<br><strong>$user = User::get(1);<br>$user-&gt;name = ‘thinkphp’;<br>$user-&gt;save();</strong><br>// 实例化模型<br>$user = new User;<br>$user-&gt;name= ‘thinkphp’;<br>$user-&gt;save();<br>// 使用 Loader 类实例化（单例）<br>$user = Loader::model(‘User’);<br>// 或者使用助手函数<code>model</code><br>$user = model(‘User’);<br>$user-&gt;name= ‘thinkphp’;<br>$user-&gt;save();<br>实例化模型类主要用于调用模型的自定义方法</p>
<p>##模型初始化<br>模型同样支持初始化，与控制器的初始化不同的是，模型的初始化是重写Model的initialize，具体如下<br>namespace app\index\model;<br>use think\Model;<br>class Index extends Model<br>{<br>    //自定义初始化<br>    protected function initialize()<br>    {<br>        //需要调用<code>Model</code>的<code>initialize</code>方法<br>        parent::initialize();<br>        //TODO:自定义的初始化<br>    }<br>}<br>模型的增删改查</p>
<p>1.添加数据</p>
<p>//添加数据前会先执行这个语句，查询是否有这个字段<br>show columns From “ecs_users”;<br>第一种是实例化模型对象后赋值并保存：</p>
<p>$user = new User;<br>$user-&gt;name= ‘thinkphp’;<br>$user-&gt;email= ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save();</p>
<p>也可以使用data方法批量赋值：<br>$user = new User;<br>$user-&gt;data([<br>‘name’ =&gt; ‘thinkphp’,<br>‘email’ =&gt; ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’<br>]);<br>$user-&gt;save();<br>save方法说明：该方法会根据你给出的类名和属性名组装成insert语句并执行。<br>第二种方法插入：<br>$userArr[‘email’]=”<a href="mailto:hello@qq.com" target="_blank" rel="noopener">hello@qq.com</a>”;<br>$userArr[‘mobile’]=’13662992253’;<br>User::create($userArr);//和save方法不同的是，create方法返回的是当前模型的对象实例</p>
<p>批量插入：<br>$users = new Users;<br>$list=[<br>[‘email’=&gt;’zhangshan.com’,’mobile’=&gt;’212121’],<br>[‘email’=&gt;’zhashan.com’,’mobile’=&gt;’212221’],<br>];<br>//注意：这是一条条记录插入，效率不高<br>$users-&gt;saveAll($list);</p>
<p>如果需要过滤非数据表字段的数据，可以使用：</p>
<p>$user = new User($_POST);<br>// 过滤post数组中的非数据表字段数据<br>$user-&gt;allowField(true)-&gt;save();<br>如果你通过外部提交赋值给模型，并且希望指定某些字段写入，可以使用：</p>
<p>$user = new User($_POST);<br>// post数组中只有name和email字段会写入<br>$user-&gt;allowField([‘name’,’email’])-&gt;save();<br>save方法新增数据返回的是写入的记录数。<br>获取自增ID<br>如果要获取新增数据的自增ID，可以使用下面的方式：</p>
<p>$user = new User;<br>$user-&gt;name = ‘thinkphp’;<br>$user-&gt;email = ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save();<br>// 获取自增ID<br>echo $user-&gt;id;<br>注意这里其实是获取模型的主键，如果你的主键不是id，而是user_id的话，其实获取自增ID就变成这样：<br>$user = new User;<br>$user-&gt;name = ‘thinkphp’;<br>$user-&gt;email = ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save();<br>// 获取自增ID<br>echo $user-&gt;user_id;<br>注意不要在同一个实例里面多次新增数据，如果确实需要多次新增，那么可以用下面的方式：</p>
<p>$user = new User;<br>$user-&gt;name = ‘thinkphp’;<br>$user-&gt;email = ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save();<br>$user-&gt;name = ‘onethink’;<br>$user-&gt;email = ‘<a href="mailto:onethink@qq.com" target="_blank" rel="noopener">onethink@qq.com</a>’;<br>// 第二次开始必须使用下面的方式新增<br>$user-&gt;isUpdate(false)-&gt;save();<br>助手函数<br>系统提供了model助手函数用于快速实例化模型，并且使用单例实现，例如：</p>
<p>// 使用model助手函数实例化User模型<br>$user = model(‘User’);<br>// 模型对象赋值<br>$user-&gt;data([<br>‘name’ =&gt; ‘thinkphp’,<br>‘email’ =&gt; ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’<br>]);<br>$user-&gt;save();</p>
<p>2.查找并更新</p>
<p>在取出数据后，更改字段内容后更新数据。</p>
<p>$user = User::get(1);<br>$user-&gt;name = ‘thinkphp’;<br>$user-&gt;email = ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save();<br>直接更新数据<br>也可以直接带更新条件来更新数据</p>
<p>$user = new User;<br>// save方法第二个参数为更新条件<br>$user-&gt;save([<br>‘name’ =&gt; ‘thinkphp’,<br>‘email’ =&gt; ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’<br>],[‘id’ =&gt; 1]);</p>
<p>过滤非数据表字段的数据，可以使用：<br>$user = new User();<br>// 过滤post数组中的非数据表字段数据，更新id=1的表的记录<br>$user-&gt;allowField(true)-&gt;save($_POST,[‘id’ =&gt; 1]);<br>指定某些字段写入，可以使用：<br>$user = new User();<br>// post数组中只有name和email字段会写入<br>$user-&gt;allowField([‘name’,’email’])-&gt;save($_POST, [‘id’ =&gt; 1]);<br>批量更新数据<br>可以使用saveAll方法批量更新数据，例如：<br>批量更新仅能根据主键值进行更新</p>
<p>$user = new User;<br>$list = [<br>    [‘id’=&gt;1, ‘name’=&gt;’thinkphp’, ‘email’=&gt;<a href="mailto:&#39;thinkphp@qq.com" target="_blank" rel="noopener">&#39;thinkphp@qq.com</a>‘],<br>    [‘id’=&gt;2, ‘name’=&gt;’onethink’, ‘email’=&gt;<a href="mailto:&#39;onethink@qq.com" target="_blank" rel="noopener">&#39;onethink@qq.com</a>‘]<br>];<br>$user-&gt;saveAll($list);<br>$user = new User;<br>$user-&gt;where(‘id’, 1)<br>    -&gt;update([‘name’ =&gt; ‘thinkphp’]);<br>或者使用：<br>$user = new User;<br>$user-&gt;update([‘id’ =&gt; 1, ‘name’ =&gt; ‘thinkphp’]);<br>如果传入update的数据包含主键的话，可以无需使用where方法。<br>静态方法<br>模型支持静态方法直接更新数据，例如：</p>
<p>User::where(‘id’, 1)<br>-&gt;update([‘name’ =&gt; ‘thinkphp’]);<br>或者使用：</p>
<p>User::update([‘id’ =&gt; 1, ‘name’ =&gt; ‘thinkphp’]);<br>闭包更新<br>可以通过闭包函数使用更复杂的更新条件，例如：</p>
<p>$user = new User;<br>$user-&gt;save([‘name’ =&gt; ‘thinkphp’],function($query){<br>// 更新status值为1 并且id大于10的数据<br>$query-&gt;where(‘status’, 1)-&gt;where(‘id’, ‘&gt;’, 10);<br>});</p>
<p>显式更新数据：<br>// 实例化模型<br>$user = new User;<br>// 显式指定更新数据操作<br>$user-&gt;isUpdate(true)<br>-&gt;save([‘id’ =&gt; 1, ‘name’ =&gt; ‘thinkphp’]);<br>显式新增数据：<br>$user = User::get(1);<br>$user-&gt;name = ‘thinkphp’;<br>// 显式指定当前操作为新增操作，isUpdate(false)表示当前为insert操作<br>$user-&gt;isUpdate(false)-&gt;save();<br>注意不要在一个模型实例里面做多次更新，会导致部分重复数据不再更新，正确的方式应该是先查询后更新或者使用模型类的update方法更新。</p>
<p>3.删除当前模型</p>
<p>删除模型数据，可以在实例化后调用delete方法。<br>//根据主键删除主键为1的数据<br>$user = User::get(1);<br>$user-&gt;delete();<br>根据主键删除<br>或者直接调用静态方法</p>
<p>User::destroy(1);<br>// 支持批量删除多个数据<br>User::destroy(‘1,2,3’);<br>// 或者<br>User::destroy([1,2,3]);<br>V5.0.9+版本开始当destroy方法传入空值（包括空字符串和空数组）的时候不会做任何的数据删除操作，但传入0则是有效的<br>条件删除<br>使用数组进行条件删除，例如：</p>
<p>// 删除状态为0的数据<br>User::destroy([‘status’ =&gt; 0]);<br>还支持使用闭包删除，例如：<br>//闭包删除可以加多种条件<br>User::destroy(function($query){<br>$query-&gt;where(‘id’,’&gt;’,10);<br>});<br>或者通过数据库类的查询条件删除<br>User::where(‘id’,’&gt;’,10)-&gt;delete();</p>
<p>4.获取单个数据</p>
<p>获取单个数据的方法包括：</p>
<p>取出主键为1的数据<br>$user = User::get(1);<br>echo $user-&gt;name;</p>
<p>根据某个条件查询数据getByXxxx()方法<br>//查询手机号为123456的数据，根据某个字段查询<br>$user=User::getByMobile(‘123456’);<br>echo $user[‘mobile’];</p>
<p>// 使用数组查询<br>$user = User::get([‘name’ =&gt; ‘111222’,’mobile’=&gt;’123456’]);<br>//使用where查询<br>$user = User::where([‘name’ =&gt; ‘111222’,’mobile’=&gt;’123456’])-&gt;find();<br>// 使用闭包查询<br>$user = User::get(function($query){<br>$query-&gt;where(‘name’, ‘thinkphp’);<br>});<br>echo $user-&gt;name;<br>如果你是在模型内部，请不要使用$this-&gt;name的方式来获取数据，请使用$this-&gt;getAttr(‘name’) 替代。<br>或者在实例化模型后调用查询方法</p>
<p>$user = new User();</p>
<p>取出多个数据：</p>
<p>// 根据主键获取多个数据,获取主键值为1,2,3的数据<br>$list = User::all(‘1,2,3’);<br>// 或者使用数组<br>$list = User::all([1,2,3]);<br>// 使用数组查询，数组方式只能定义查询条件<br>$list = User::all([‘status’=&gt;1]);<br>// 使用闭包查询，闭包方式可以支持更多的连贯操作，包括排序、数量限制等。<br>$list = User::all(function($query){<br>$query-&gt;where(‘status’, 1)-&gt;limit(3)-&gt;order(‘id’, ‘asc’);<br>});<br>foreach($list as $key=&gt;$user){<br>echo $user-&gt;name;<br>}<br>在实例化模型后调用查询方法</p>
<p>$user = new User();<br>// 查询数据集<br>$user-&gt;where(‘name’, ‘thinkphp’)<br>-&gt;limit(10)<br>-&gt;order(‘id’, ‘desc’)<br>-&gt;select();<br>模型的all方法或者select方法返回的是一个包含模型对象的二维数组或者数据集对象。<br>获取某个字段或者某个列的值<br>// 获取某个用户的积分<br>User::where(‘id’,10)-&gt;value(‘score’);<br>// 获取某个列的所有值<br>User::where(‘status’,1)-&gt;column(‘name’);<br>// 以id为索引<br>User::where(‘status’,1)-&gt;column(‘name’,’id’);<br>查询缓存<br>get方法和all方法的第三个参数表示是否使用查询缓存，或者设置缓存标识。<br>$user = User::get(1,’’,true);<br>$list = User::all(‘1,2,3’,’’,true);//true表示开启查询缓存。</p>
<p>5.聚合</p>
<p>在模型中也可以调用数据库的聚合方法进行查询，例如：</p>
<p>方法|说明<br>count|统计数量，参数是要统计的字段名（可选）<br>max|获取最大值，参数是要统计的字段名（必须）<br>min|获取最小值，参数是要统计的字段名（必须）<br>avg|获取平均值，参数是要统计的字段名（必须）<br>sum|获取总分，参数是要统计的字段名（必须）<br>静态调用：<br>//统计数量</p>
<p>$user = new User;<br>User::count();<br>User::where(‘status’,’&gt;’,0)-&gt;count();<br>//统计status=1的score的平均值<br>User::where(‘status’,1)-&gt;avg(‘score’);<br>//统计score的最大值<br>User::max(‘score’);</p>
<p>获取器（读取器）</p>
<p>读取器方法的命名规范：get+属性名的驼峰命名+Attr<br>程序在读取属性时自动根据规则监测是否有这个属性对应的方法<br>$user=Users::get(1);<br>echo $user-&gt;email;//自动监测是否有getEmailAttr方法，如果有写则调用并把原来的值传给该方法，并由该方法返回相应的数据,没有找到则调用默认数据。<br>获取器的作用是在[获取数据]的字段值后自动进行处理，例如，我们需要对状态值进行转换，可以使用：</p>
<p>class User extends Model<br>{<br>public function getStatusAttr($value)<br>{<br>$status = [-1=&gt;’删除’,0=&gt;’禁用’,1=&gt;’正常’,2=&gt;’待审核’];<br>return $status[$value];<br>}<br>}<br>$user = User::get(1);<br>echo $user-&gt;status; // 例如输出“正常”<br>获取器还可以定义数据表中不存在的字段，例如：</p>
<p>class User extends Model<br>{<br>//获取器方法的第二个参数传入的是当前的所有数据数组。<br>public function getStatusTextAttr($value,$data)<br>{<br>$status = [-1=&gt;’删除’,0=&gt;’禁用’,1=&gt;’正常’,2=&gt;’待审核’];<br>return $status[$data[‘status’]];<br>}<br>}<br>我们就可以直接使用status_text字段的值了，例如：<br>$user = User::get(1);<br>echo $user-&gt;status_text; // 例如输出“正常”，获取器只有当获取某个数据属性的时候自动触发</p>
<p>获取原始数据<br>如果你定义了获取器的情况下，希望获取数据表中的原始数据，可以使用：</p>
<p>$user = User::get(1);<br>// 获取原始字段数据<br>echo $user-&gt;getData(‘status’);<br>// 获取全部原始数据<br>dump($user-&gt;getData());</p>
<p>修改器（写入器）</p>
<p>命名规范：set+属性名的驼峰命名+Attr<br>修改器的作用是可以在数据赋值的时候自动进行转换处理，例如：</p>
<p>class User extends Model<br>{<br>public function setNameAttr($value)<br>{<br>return strtolower($value);//把字符转换成小写并返回<br>}<br>}<br>如下代码实际保存到数据库中的时候会转为小写</p>
<p>$user = new User();<br>$user-&gt;name = ‘THINKPHP’;//插入或者更新数据的时候自动监测是否有修改器，如果有则调用相应的修改器，并把返回的结果插入数据库，例如：插入省市区的id的时候可以通过修改器来获取id对应的地名<br>$user-&gt;save();<br>echo $user-&gt;name; // thinkphp<br>也可以进行序列化字段的组装：</p>
<p>class User extends Model<br>{<br>public function setNameAttr($value,$data)<br>{<br>return serialize($data);<br>}<br>}<br>修改器方法的第二个参数会自动传入当前的所有数据数组。<br>批量修改<br>除了赋值的方式可以触发修改器外，还可以直接使用save方法触发，例如：</p>
<p>$user = new User();<br>$data[‘name’] = ‘THINKPHP’;<br>$data[‘email’] = ‘<a href="mailto:thinkphp@qq.com" target="_blank" rel="noopener">thinkphp@qq.com</a>’;<br>$user-&gt;save($data);//保存数据的同时监测是否有修改器<br>echo $user-&gt;name; // thinkphp</p>
<p>时间戳</p>
<p>autoWriteTimestamp属性支持设置为时间日期类名<br>系统支持自动写入创建和更新的时间戳字段，有两种方式配置支持。</p>
<p>第一种方式，是在数据库配置文件中添加全局设置：</p>
<p>// 开启自动写入时间戳字段<br>‘auto_timestamp’ =&gt; true,<br>// 关闭全局自动写入时间字段<br>‘auto_timestamp’ =&gt; false,</p>
<p>写入数据的时候，系统会自动写入create_time和update_time字段，而不需要定义修改器，例如：<br>$user = new User();<br>$user-&gt;name = ‘THINKPHP’;<br>$user-&gt;save();<br>echo $user-&gt;create_time; // 输出类似 2016-10-12 14:20:10<br>echo $user-&gt;update_time; // 输出类似 2016-10-12 14:20:10</p>
<p>如果你的数据表字段不是默认值的话（create_time，update_time），可以按照下面的方式定义：</p>
<p>class User extends Model<br>{<br>// 定义时间戳字段名<br>protected $createTime = ‘create_at’;//【自定义的数据库字段】<br>protected $updateTime = ‘update_at’;//【自定义的数据库字段】<br>}<br>下面是修改字段后的输出代码：</p>
<p>$user = new User();<br>$user-&gt;name = ‘THINKPHP’;<br>$user-&gt;save();<br>echo $user-&gt;create_at; // 输出类似 2016-10-12 14:20:10<br>echo $user-&gt;update_at; // 输出类似 2016-10-12 14:20:10<br>如果你只需要使用create_time字段而不需要自动写入update_time，则可以单独设置关闭某个字段，例如：<br>class User extends Model<br>{<br>// 关闭自动写入update_time字段<br>protected $updateTime = false;<br>}<br>如果不需要任何自动写入的时间戳字段的话，可以关闭时间戳自动写入功能，关闭当前model设置如下：<br>class User extends Model<br>{<br>// 关闭自动写入时间戳<br>protected $autoWriteTimestamp = false;<br>}</p>
<p>只读字段</p>
<p>只读字段用来保护某些特殊的字段值不被更改，这个字段的值一旦写入，就无法更改。 要使用只读字段的功能，我们只需要在模型中定义readonly属性：<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>//定义了当前模型的name和email字段为只读字段，不允许被更改。也就是说当执行更新方法之前会自动过滤掉只读字段的值，避免更新到数据库。<br>protected $readonly = [‘name’,’email’];<br>}</p>
<p>下面举个例子说明下：</p>
<p>$user = User::get(5);<br>// 更改某些字段的值<br>$user-&gt;name = ‘TOPThink’;<br>$user-&gt;email = ‘<a href="mailto:Topthink@gmail.com" target="_blank" rel="noopener">Topthink@gmail.com</a>’;<br>$user-&gt;address = ‘上海静安区’;<br>// 保存更改后的用户数据<br>$user-&gt;save();<br>事实上，由于我们对name和email字段设置了只读，因此只有address字段的值被更新了，而name和email的值仍然还是更新之前的值。</p>
<p>软删除</p>
<p>在实际项目中，对数据频繁使用删除操作会导致性能问题，软删除的作用就是把数据加上删除标记，而不是真正的删除，同时也便于需要的时候进行数据的恢复。</p>
<p>要使用软删除功能，需要引入SoftDelete trait，例如User模型按照下面的定义就可以使用软删除功能：<br>namespace app\index\model;</p>
<p>use think\Model;<br>use traits\model\SoftDelete;//必须引入</p>
<p>class User extends Model<br>{<br>use SoftDelete;<br>//5.0.2版本之前deleteTime属性必须使用static定义。<br>protected $deleteTime = ‘delete_time’;//【需要软删除的数据库字段为detele_time】<br>}<br>// 软删除<br>1.方式1<br>User::destroy(1);<br>2.方式2<br>User::get(1);//软删除后获取不到数据，为空<br>$user-&gt;delete();<br>默认情况下查询的数据不包含软删除数据，如果需要包含软删除的数据，可以使用下面的方式查询：<br>User::withTrashed()-&gt;find();<br>$res=User::withTrashed()-&gt;select();<br>echo $res-&gt;getData();<br>如果仅仅需要查询软删除的数据，可以使用：<br>User::onlyTrashed()-&gt;find();<br>User::onlyTrashed()-&gt;select();<br>// 真实删除<br>1.方式1<br>User::destroy(1,true);<br>2.方式2<br>$user = User::get(1);<br>$user-&gt;delete(true);</p>
<p>类型转换</p>
<p>支持给字段设置类型自动转换，会在写入和读取的时候自动进行类型转换处理，例如：</p>
<p>class User extends Model<br>{<br>protected $type = [<br>‘status’ =&gt; ‘integer’,<br>‘score’ =&gt; ‘float’,<br>‘birthday’ =&gt; ‘datetime’,<br>‘info’ =&gt; ‘array’,<br>];<br>}<br>下面是一个类型自动转换的示例：</p>
<p>$user = new User;<br>$user-&gt;status = ‘1’;//指定为int类型<br>$user-&gt;score = ‘90.50’;//指定为float类型<br>$user-&gt;birthday = ‘2015/5/1’;//指定为日期类型<br>$user-&gt;info = [‘a’=&gt;1,’b’=&gt;2];//指定为数组类型<br>$user-&gt;save();<br>var_dump($user-&gt;status); // int 1<br>var_dump($user-&gt;score); // float 90.5;<br>var_dump($user-&gt;birthday); // string ‘2015-05-01 00:00:00’<br>var_dump($user-&gt;info);// array (size=2) ‘a’ =&gt; int 1 ‘b’ =&gt; int 2<br>数据库查询默认取出来的数据都是字符串类型，如果需要转换为其他的类型，需要设置，支持的类型包括如下类型：</p>
<p>integer</p>
<p>设置为integer（整型）后，该字段写入和输出的时候都会自动转换为整型。</p>
<p>float</p>
<p>该字段的值写入和输出的时候自动转换为浮点型。</p>
<p>boolean</p>
<p>该字段的值写入和输出的时候自动转换为布尔型。</p>
<p>array</p>
<p>如果设置为强制转换为array类型，系统会自动把数组编码为json格式字符串写入数据库，取出来的时候会自动解码。<br>object</p>
<p>该字段的值在写入的时候会自动编码为json字符串，输出的时候会自动转换为stdclass对象。<br>serialize</p>
<p>指定为序列化类型的话，数据会自动序列化写入，并且在读取的时候自动反序列化。</p>
<p>json</p>
<p>指定为json类型的话，数据会自动json_encode写入，并且在读取的时候自动json_decode处理。<br>timestamp</p>
<p>指定为时间戳字段类型的话，该字段的值在写入时候会自动使用strtotime生成对应的时间戳，输出的时候会自动转换为dateFormat属性定义的时间字符串格式，默认的格式为Y-m-d H:i:s，如果希望改变其他格式，可以定义如下：<br>class User extends Model<br>{<br>protected $dateFormat = ‘Y/m/d’;<br>protected $type = [<br>‘status’ =&gt; ‘integer’,<br>‘score’ =&gt; ‘float’,<br>‘birthday’ =&gt; ‘timestamp’,<br>];<br>}<br>或者在类型转换定义的时候使用：</p>
<p>class User extends Model<br>{<br>//定义各个字段的类型<br>protected $type = [<br>‘status’ =&gt; ‘integer’,<br>‘score’ =&gt; ‘float’,<br>‘birthday’ =&gt; ‘timestamp:Y/m/d’,<br>];<br>}<br>然后就可以</p>
<p>$user = User::find(1);<br>echo $user-&gt;birthday; // 2015/5/1<br>datetime</p>
<p>和timestamp类似，区别在于写入和读取数据的时候都会自动处理成时间字符串Y-m-d H:i:s的格式。</p>
<p>数据完成</p>
<p>关系区分：修改器和数据完成功能一样，修改器在数据赋值的时候对数据进行处理，数据完成支持auto、insert和update三个属性，可以分别在写入、新增和更新的时候进行处理，数据完成和修改器只能使用一个，否则将可能导致插入数据库的数据发生错乱，例如出现密码被两次加密的情况。<br>数据自动完成指在不需要手动赋值的情况下对字段的值进行处理后写入数据库。</p>
<p>系统支持auto、insert和update三个属性，可以分别在写入、新增和更新的时候进行字段的自动完成机制，auto属性自动完成包含新增和更新操作，例如我们定义User模型类如下：<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>protected $auto = [];<br>protected $insert = [‘ip’,’status’ =&gt; 1];<br>protected $update = [‘login_ip’];</p>
<p>protected function setIpAttr()<br>{<br>    return request()-&gt;ip();<br>}<br>}<br>在新增数据的时候，会对ip和 status 字段自动完成或者处理。<br>$user = new User;<br>$user-&gt;name = ‘ThinkPHP’;<br>$user-&gt;save();<br>echo $user-&gt;name; // thinkphp<br>echo $user-&gt;status; // 1<br>在保存操作的时候，会自动完成ip字段的赋值。<br>$user = User::find(1);<br>$user-&gt;name = ‘THINKPHP’;<br>$user-&gt;save();<br>echo $user-&gt;name; // thinkphp<br>echo $user-&gt;ip; // 127.0.0.1</p>
<p>模型分层</p>
<p>ThinkPHP支持模型的分层 ，除了Model层之外，我们可以项目的需要设计和创建其他的模型层。</p>
<p>通常情况下，不同的分层模型仍然是继承系统的\think\Model类或其子类，所以，其基本操作和Model类的操作是一致的。<br>例如在index模块的设计中需要区分数据层、逻辑层、服务层等不同的模型层，我们可以在模块目录下面创建model、logic和service目录，把对用户表的所有模型操作分成三层：<br>数据层：app\index\model\User 用于定义数据相关的自动验证和自动完成和数据存取接口<br>逻辑层：app\index\logic\User 用于定义用户相关的业务逻辑<br>服务层：app\index\service\User 用于定义用户相关的服务接口等</p>
<p>JSON序列化</p>
<p>1.可以调用模型的toJson方法进行JSON序列化<br>$user = User::get(1);<br>设置无需输出的字段<br>echo $user-&gt;hidden([‘create_time’,’update_time’])-&gt;toJson();<br>或者追加其它的字段：<br>$user = User::get(1);<br>echo $user-&gt;append([‘status_text’])-&gt;toJson();<br>设置允许输出的属性：<br>$user = User::get(1);<br>echo $user-&gt;visible([‘id’,’name’,’email’])-&gt;toJson();<br>2.模型对象可以直接被JSON序列化==直接echo 一个模型对象，例如：<br>echo json_encode(User::get(1));===echo User::get(1);<br>输出结果类似于：<br>{“id”:”1”,”name”:””,”title”:””,”status”:”1”,”update_time”:”1430409600”,”score”:”90.5”}</p>
<p>关联</p>
<p>一般来说，关联关系包括：<br>一对一关联（一个用户一个档案）：HAS_ONE以及相对的BELONGS_TO<br>一对多关联（一个用户多条评论）：HAS_MAMY以及相对的BELONGS_TO<br>多对多关联（多个同学对应多个老师，一个同学听多个老师的课，一个老师教多个同学）：BELONGS_TO_MANY<br>使用流程示例：<br>1.创建Users模型<br>2.创建Comment模型<br>3.在Users模型中添加方法HAS_ONE、HAS_MAMY<br>4.在Comment模型中添加方法BELONGS_TO<br>5.测试</p>
<p>一对一关联</p>
<p>一对一：一个用户一个档案；一夫一妻制等<br>定义<br>关联方法的命名规范是驼峰法，而关联属性则一般是小写+下划线的方式，系统在获取的时候会自动转换对应，读取user_profile关联属性则对应的关联方法应该是userProfile。<br>定义一对一关联，例如，一个用户(users)都有一个个人资料(profile)，我们定义User模型如下：</p>
<p>hasOne方法的参数包括：<br>hasOne(‘关联模型名’,‘外键名’,‘主键名’,[‘模型别名定义’],‘join类型’);<br>默认的join类型为INNER（内联接）。其他（Outer join：外部联接；cross join：交叉联接）<br>关联模型定义需要查询的字段，例如：<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>public function profile()<br>{//关联模型Profile,默认情况下， 我们使用的是user_id 作为外键关联<br>return $this-&gt;hasOne(‘Profile’)-&gt;field(‘id,name,email’);<br>}<br>}<br>关联查找<br>定义好关联之后，就可以使用下面的方法获取关联数据：<br>$user = User::get(1);<br>// 输出Profile关联模型的email属性<br>echo $user-&gt;profile-&gt;email;//把profile模型（表）中的email数据输出<br>默认情况下， 我们使用的是user_id 作为外键关联，如果不是的话则需要在关联定义的时候指定，例如：<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>public function profile()<br>{<br>return $this-&gt;hasOne(‘Profile’,’uid’);<br>}<br>}</p>
<p>设置别名<br>如果你的模型名和数据库关键字冲突的话，可以设置别名，例如：</p>
<p>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>public function profile()<br>{<br>//用别名函数设置当前模型名称为member<br>return $this-&gt;hasOne(‘Profile’,’uid’)-&gt;setAlias([‘user’=&gt;’member’]);<br>}<br>}<br>关联新增<br>$user = User::get(1);<br>// 如果还没有关联数据 则进行新增<br>系统会自动把当前模型的主键user_id传入profile模型，然后在ProFile模型中找到主键uid=user_id的数据，然后对该数据记录进行更新<br>$user-&gt;profile()-&gt;save([‘email’ =&gt; ‘thinkphp’]);//数组写法</p>
<p>使用save方法进行更新关联数据。<br>$user = User::get(1);<br>$user-&gt;profile-&gt;email = ‘thinkphp’;//直接赋值的写法<br>$user-&gt;profile-&gt;save();</p>
<p>定义相对的关联<br>我们可以在Profile模型中定义一个相对的关联关系，例如：<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class Profile extends Model<br>{<br>public function user()<br>{<br>//定义相对关联关系<br>return $this-&gt;belongsTo(‘User’);<br>}<br>}<br>belongsTo的参数包括：<br>belongsTo(‘关联模型名’,‘外键名’,‘关联表主键名’,[‘模型别名定义’],‘join类型’);<br>默认的关联外键是user_id，如果不是，需要在第二个参数定义<br>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class Profile extends Model<br>{<br>public function user()<br>{<br>return $this-&gt;belongsTo(‘User’,’uid’);<br>}<br>}<br>我们就可以根据档案资料来获取用户模型的信息</p>
<p>$profile = Profile::get(1);<br>// 输出User关联模型的属性<br>echo $profile-&gt;user-&gt;account;</p>
<p>可以在定义关联的时候使用bind方法绑定属性到父模型，例如：</p>
<p>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>public function profile()<br>{//把user和profile里面的相同字段nickname,email相互关联<br>return $this-&gt;hasOne(‘Profile’,’uid’)-&gt;bind(‘nickname,email’);<br>}<br>}<br>或者使用数组的方式指定绑定属性别名</p>
<p>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class User extends Model<br>{<br>public function profile()<br>{<br>return $this-&gt;hasOne(‘Profile’,’uid’)-&gt;bind([<br>‘email’,<br>‘truename’=&gt; ‘nickname’,//user表中的truename和profile表中的nickname关联<br>‘profile_id’ =&gt; ‘id’,//user表中的profile_id和profile表中的id关联<br>]);<br>}<br>}<br>然后使用关联预载入查询的时候，可以使用</p>
<p>$user = User::get(1,’profile’);<br>// 输出Profile关联模型的email属性<br>echo $user-&gt;email;<br>echo $user-&gt;profile_id;<br>绑定关联属性不影响原有关联属性的读取，绑定关联模型的属性支持读取器。</p>
<p>我们可以使用together方法更方便的进行关联自动写入操作。<br>把blog和content进行关联<br>写入<br>$blog = new Blog;<br>$blog-&gt;name = ‘thinkphp’;//更改当前模型的name的值<br>$blog-&gt;title = ‘ThinkPHP5关联实例’;<br>$content = new Content;<br>$content-&gt;data = ‘实例内容’;//更改关联模型的data值<br>$blog-&gt;content = $content;//当前模型blog和content模型进行关联<br>//// 更新当前模型及关联模型<br>$blog-&gt;together(‘content’)-&gt;save();</p>
<p>// 查询<br>$blog = Blog::get(1);<br>$blog-&gt;title = ‘更改标题’;//更改当前模型的title<br>$blog-&gt;content-&gt;data = ‘更新内容’;//更改关联模型content的data<br>// 更新当前模型及关联模型<br>$blog-&gt;together(‘content’)-&gt;save();<br>删除</p>
<p>// 查询主键为1的记录<br>$blog = Blog::get(1);<br>// 删除当前及关联模型<br>$blog-&gt;together(‘content’)-&gt;delete();</p>
<p>一对多关联</p>
<p>一对多：一个用户多条评论；一篇文章可以有多个评论;<br>一对多关联的情况也比较常见，使用hasMany方法定义，<br>参数包括：<br>hasMany(‘关联模型名’,‘外键名’,‘主键名’,[‘模型别名定义’]);<br>例如一篇文章可以有多个评论</p>
<p>namespace app\index\model;</p>
<p>use think\Model;</p>
<p>class Article extends Model<br>{<br>public function comments()<br>{//Article和Comment表进行关联,外键是comments表的主键comments_id,主键名是article表的article_id<br>return $this-&gt;hasMany(‘Comment’,’comments_id’,’article_id’)-&gt;field(‘id,author,content’);<br>}<br>}</p>
<p>关联查询<br>我们可以通过下面的方式获取关联数据</p>
<p>// 获取id=1的文章的所有评论<br>$article=Article::get(1);<br>dump($article-&gt;comments);<br>foreach($article-&gt;comments as)<br>// 也可以进行条件搜索<br>dump($article-&gt;comments()-&gt;where(‘status’,1)-&gt;select());<br>根据关联条件查询<br>可以根据关联条件来查询当前模型对象数据，例如：</p>
<p>// 查询评论超过3个的文章<br>$list = Article::has(‘comments’,’&gt;’,3)-&gt;select();<br>// 查询评论状态正常的文章<br>$list = Article::hasWhere(‘comments’,[‘status’=&gt;1])-&gt;select();<br>关联新增</p>
<p>// 增加一个关联数据，<br>$article = Article::find(1);//找到article为1的数据记录<br>//设置comment中的字段content内容为test<br>$article-&gt;comments()-&gt;save([‘content’=&gt;’test’]);<br>// 批量增加关联数据<br>$article-&gt;comments()-&gt;saveAll([<br>[‘content’=&gt;’thinkphp’],<br>[‘content’=&gt;’onethink’],<br>]);<br>定义相对的关联<br>要在 Comment 模型定义相对应的关联，可使用 belongsTo 方法：<br>name app\index\model;<br>use think\Model;<br>class Comment extends Model<br>{<br>public function article()<br>{<br>return $this-&gt;belongsTo(‘article’);<br>}<br>}</p>
<p>多对多关联</p>
<p>多对多：多个同学对应多个老师；多个用户多个角色（一个用户有多个角色，一个角色对应多个用户）<br>belongsToMany方法的参数如下：<br>belongsToMany(‘关联模型名’,‘中间表名’,‘外键名’,‘当前模型关联键名’,[‘模型别名定义’]);<br>tpshop举例：地区表region;配送区域表shipping_area;他们通过area_region配送区域和地区关联表关联（也叫中间表，枢纽表），一个城市对应多个地区，一个地区对应多个城市，广州是珠三角，中国一线城市，珠三角地区包括深圳，广州<br>该中间表只有两个字段</p>
<p>创建地区模型<br>namespace app\index\model;<br>use think\Model;<br>class Region extends Model<br>{<br>public function shippingArea()<br>{//关联ShippingArea模型，中间表是tp_area_region,通过这shipping_area_id，region_id两个字段关联<br>return $this-&gt;belongsToMany(‘ShippingArea’,’area_region’，’shipping_area_id’,’region_id’);<br>}<br>}<br>创建配送区域的模型<br>namespace app\index\model;<br>use think\Model;<br>class ShippingArea extends Model<br>{<br>public function region()<br>{//关联Region模型，中间表是tp_area_region,通过这shipping_area_id，region_id两个字段关联，字段顺序不影响<br>return $this-&gt;belongsToMany(‘ShippingArea’,’area_region’，’shipping_area_id’,’region_id’);<br>}<br>}<br>//不需要配置中间模型<br>关联定义<br>例如，我们的用户和角色就是一种多对多的关系，我们在User模型定义如下：<br>namespace app\index\model;<br>use think\Model;<br>class User extends Model<br>{<br>public function roles()<br>{<br>return $this-&gt;belongsToMany(‘Role’);<br>}<br>}</p>
<p>关联查询<br>我们可以通过下面的方式获取关联数据<br>//查出北京市的地区记录<br>$region=Region::getByName(‘北京市’)；<br>//新增配送区域，并自动写入枢纽表<br>$region-&gt;shippingArea()-&gt;save([‘shipping_area_name’]=&gt;’中国首都’)</p>
<p>// 获取用户的所有角色</p>
<p>关联新增</p>
<p>// 批量增加关联数据<br>$region-&gt;shippingArea()-&gt;saveAll([<br>[‘shipping_area_name’=&gt;’北京’],<br>[‘shipping_area_name’=&gt;’广州’],<br>]);<br>只新增中间表数据，可以使用</p>
<p>// 仅增加关联的中间表数据<br>$region-&gt;shippingArea()-&gt;save(1);</p>
<p>// 批量增加关联数据<br>$region-&gt;shippingArea()-&gt;saveAll([1,2,3]);<br>单独更新中间表数据，可以使用：</p>
<p>// 增加关联的中间表数据<br>$region-&gt;shippingArea()-&gt;attach(1);<br>// 传入中间表的额外属性<br>$region-&gt;shippingArea()-&gt;attach(1,[‘remark’=&gt;’test’]);<br>// 删除中间表数据<br>$region-&gt;shippingArea()-&gt;detach([1,2,3]);</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/10/hello-world/" rel="next" title="hexo 使用文档">
                <i class="fa fa-chevron-left"></i> hexo 使用文档
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/24/ionic-angular/" rel="prev" title="ionic-angular">
                ionic-angular <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/logo.png" alt="Berlin">
            
              <p class="site-author-name" itemprop="name">Berlin</p>
              <p class="site-description motion-element" itemprop="description">如履薄冰,自信感恩！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.berlinchans.com" target="_blank" title="Home">
                      
                        <i class="fa fa-fw fa-home"></i>Home</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/berlincc" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:berlinchans@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/108865511809861056171" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://chchc.me/" title="华超的博客" target="_blank">华超的博客</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Berlin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">9.0k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
